-- Databricks notebook source
-- MAGIC %python
-- MAGIC catalog = dbutils.widgets.get("catalog")
-- MAGIC spark.sql(f"USE CATALOG {catalog}")
-- COMMAND ----------


-- Statement 1
CREATE OR REPLACE TABLE tmp.TEMP_SALES_DATA_tmp AS (
    SELECT DISTINCT
        P.PRODUCT_ID,
        P.PRODUCT_NAME,
        P.CATEGORY,
        S.SALE_ID,
        S.SALE_DATE,
        S.QUANTITY,
        S.UNIT_PRICE,
        S.TOTAL_AMOUNT
    FROM DEMO.PRODUCT_V AS P
    LEFT OUTER JOIN DEMO.SALES_FACT AS S
        ON P.PRODUCT_ID = S.PRODUCT_ID
    WHERE P.PRODUCT_STATUS = 'ACTIVE'
);


-- Statement 2

-- COMMAND ----------
BEGIN ATOMIC


-- Statement 3
MERGE INTO DEMO.PRODUCT_SUMMARY AS A
USING (
    SELECT
        PRODUCT_ID,
        COUNT(*) AS SALE_COUNT,
        SUM(TOTAL_AMOUNT) AS TOTAL_REVENUE
    FROM tmp.TEMP_SALES_DATA_tmp
    GROUP BY PRODUCT_ID
) AS B
    ON A.PRODUCT_ID = B.PRODUCT_ID
WHEN MATCHED THEN
    UPDATE SET
        SALE_COUNT = B.SALE_COUNT,
        TOTAL_REVENUE = B.TOTAL_REVENUE,
        LAST_UPDATED = CURRENT_TIMESTAMP();


-- Statement 4
INSERT INTO DEMO.PRODUCT_DETAILS
(
    PRODUCT_ID, PRODUCT_NAME, CATEGORY, SALE_COUNT, TOTAL_REVENUE,
    CREATED_DATE, LAST_UPDATED
)
SELECT
    PRODUCT_ID,
    PRODUCT_NAME,
    CATEGORY,
    COUNT(*) AS SALE_COUNT,
    SUM(TOTAL_AMOUNT) AS TOTAL_REVENUE,
    CURRENT_DATE AS CREATED_DATE,
    CURRENT_TIMESTAMP() AS LAST_UPDATED
FROM tmp.TEMP_SALES_DATA_tmp
GROUP BY PRODUCT_ID, PRODUCT_NAME, CATEGORY;


-- Statement 5
INSERT INTO DEMO.SALES_REPORTING
(
    REPORT_DATE, PRODUCT_ID, PRODUCT_NAME, CATEGORY_NAME,
    SALE_COUNT, TOTAL_REVENUE, REGION
)
SELECT
    CURRENT_DATE AS REPORT_DATE,
    P.PRODUCT_ID,
    P.PRODUCT_NAME,
    C.CATEGORY_NAME,
    COUNT(S.SALE_ID) AS SALE_COUNT,
    SUM(S.TOTAL_AMOUNT) AS TOTAL_REVENUE,
    R.REGION_NAME AS REGION
FROM tmp.TEMP_SALES_DATA_tmp AS P
LEFT OUTER JOIN DEMO.CATEGORY AS C
    ON P.CATEGORY = C.CATEGORY_CODE
LEFT OUTER JOIN DEMO.SALES_FACT AS S
    ON P.PRODUCT_ID = S.PRODUCT_ID
LEFT OUTER JOIN DEMO.REGION AS R
    ON S.REGION_ID = R.REGION_ID
GROUP BY P.PRODUCT_ID, P.PRODUCT_NAME, C.CATEGORY_NAME, R.REGION_NAME;


-- Statement 6
INSERT INTO DEMO.AUDIT_LOG
(PROCESS_NAME, TABLE_NAME, RECORD_COUNT, PROCESS_DATE, STATUS)
SELECT
    'SALES_ETL' AS PROCESS_NAME,
    'DEMO.SALES_REPORTING' AS TABLE_NAME,
    COUNT(*) AS RECORD_COUNT,
    CURRENT_DATE AS PROCESS_DATE,
    'COMPLETED' AS STATUS
FROM DEMO.SALES_REPORTING
WHERE REPORT_DATE = CURRENT_DATE;


-- Statement 7

END;
-- COMMAND ----------

